# Phase 3.5: Consolidation Agent

匯總所有分析 Agent 的產出，生成跨章節綜合分析，為 Phase 4 索引報告提供內容。

> **寫作規範**: [../specs/writing-style.md](../specs/writing-style.md)

## 執行要求

**必須執行**：Phase 3 所有 Analysis Agents 完成後，主編排器**必須**調用此 Consolidation Agent。

**觸發條件**：

- Phase 3 所有 agent 已返回結果（status: completed/partial/failed）
- `sections/section-*.md` 文件已生成

**輸入來源**：

- `agent_summaries`: Phase 3 各 agent 返回的 JSON（包含 status, output_file, summary, cross_module_notes）
- `cross_module_notes`: 從各 agent 返回中提取的跨模塊備注數組

**調用時機**：

```javascript
// Phase 3 完成後，主編排器執行：
const phase3Results = await runPhase3Agents(); // 並行執行所有 analysis agents
const agentSummaries = phase3Results.map((r) => JSON.parse(r));
const crossNotes = agentSummaries.flatMap((s) => s.cross_module_notes || []);

// 必須調用 Phase 3.5 Consolidation Agent
await runPhase35Consolidation(agentSummaries, crossNotes);
```

## 核心職責

1. **跨章節綜合分析**：生成 synthesis（報告綜述）
2. **章節摘要提取**：生成 section_summaries（索引表格內容）
3. **質量檢查**：識別問題並評分
4. **建議匯總**：生成 recommendations（優先級排序）

## 輸入

```typescript
interface ConsolidationInput {
  output_dir: string;
  config: AnalysisConfig;
  agent_summaries: AgentReturn[];
  cross_module_notes: string[];
}
```

## Agent 調用代碼

主編排器使用以下代碼調用 Consolidation Agent：

```javascript
Task({
  subagent_type: "cli-explore-agent",
  run_in_background: false,
  prompt: `
## 規範前置
首先讀取規範文件：
- Read: ${skillRoot}/specs/quality-standards.md
- Read: ${skillRoot}/specs/writing-style.md
嚴格遵循規範中的質量標準和段落式寫作要求。

## 任務
作為匯總 Agent，讀取所有章節文件，執行跨章節分析，生成匯總報告和索引內容。

## 輸入
- 章節文件: ${outputDir}/sections/section-*.md
- Agent 摘要: ${JSON.stringify(agent_summaries)}
- 跨模塊備注: ${JSON.stringify(cross_module_notes)}
- 報告類型: ${config.type}

## 核心產出

### 1. 綜合分析 (synthesis)
閱讀所有章節，用 2-3 段落描述項目全貌：
- 第一段：項目定位與核心架構特征
- 第二段：關鍵設計決策與技術選型
- 第三段：整體質量評價與顯著特點

### 2. 章節摘要 (section_summaries)
為每個章節提取一句話核心發現，用於索引表格。

### 3. 架構洞察 (cross_analysis)
描述章節間的關聯性，如：
- 模塊間的依賴關系如何體現在各章節
- 設計決策如何貫穿多個層面
- 潛在的一致性或沖突

### 4. 建議匯總 (recommendations)
按優先級整理各章節的建議，段落式描述。

## 質量檢查維度

### 一致性檢查
- 術語一致性：同一概念是否使用相同名稱
- 代碼引用：file:line 格式是否正確

### 完整性檢查
- 章節覆蓋：是否涵蓋所有必需章節
- 內容深度：每章節是否達到 ${config.depth} 級別

### 質量檢查
- Mermaid 語法：圖表是否可渲染
- 段落式寫作：是否符合寫作規範（禁止清單羅列）

## 輸出文件

寫入: ${outputDir}/consolidation-summary.md

### 文件格式

\`\`\`markdown
# 分析匯總報告

## 綜合分析

[2-3 段落的項目全貌描述，段落式寫作]

## 章節摘要

| 章節 | 文件 | 核心發現 |
|------|------|----------|
| 系統概述 | section-overview.md | 一句話描述 |
| 層次分析 | section-layers.md | 一句話描述 |
| ... | ... | ... |

## 架構洞察

[跨章節關聯分析，段落式描述]

## 建議匯總

[優先級排序的建議，段落式描述]

---

## 質量評估

### 評分

| 維度 | 得分 | 說明 |
|------|------|------|
| 完整性 | 85% | ... |
| 一致性 | 90% | ... |
| 深度 | 95% | ... |
| 可讀性 | 88% | ... |
| 綜合 | 89% | ... |

### 發現的問題

#### 嚴重問題
| ID | 類型 | 位置 | 描述 |
|----|------|------|------|
| E001 | ... | ... | ... |

#### 警告
| ID | 類型 | 位置 | 描述 |
|----|------|------|------|
| W001 | ... | ... | ... |

#### 提示
| ID | 類型 | 位置 | 描述 |
|----|------|------|------|
| I001 | ... | ... | ... |

### 統計

- 章節數: X
- 圖表數: X
- 總字數: X
\`\`\`

## 返回格式 (JSON)

{
  "status": "completed",
  "output_file": "consolidation-summary.md",

  // Phase 4 索引報告所需
  "synthesis": "2-3 段落的綜合分析文本",
  "cross_analysis": "跨章節關聯分析文本",
  "recommendations": "優先級排序的建議文本",
  "section_summaries": [
    {"file": "section-overview.md", "title": "系統概述", "summary": "一句話核心發現"},
    {"file": "section-layers.md", "title": "層次分析", "summary": "一句話核心發現"}
  ],

  // 質量信息
  "quality_score": {
    "completeness": 85,
    "consistency": 90,
    "depth": 95,
    "readability": 88,
    "overall": 89
  },
  "issues": {
    "errors": [...],
    "warnings": [...],
    "info": [...]
  },
  "stats": {
    "total_sections": 5,
    "total_diagrams": 8,
    "total_words": 3500
  }
}
`,
});
```

## 問題分類

| 嚴重級別 | 前綴 | 含義         | 處理方式 |
| -------- | ---- | ------------ | -------- |
| Error    | E    | 阻塞報告生成 | 必須修覆 |
| Warning  | W    | 影響報告質量 | 建議修覆 |
| Info     | I    | 可改進項     | 可選修覆 |

## 問題類型

| 類型          | 說明               |
| ------------- | ------------------ |
| missing       | 缺失章節           |
| inconsistency | 術語/描述不一致    |
| invalid_ref   | 無效代碼引用       |
| syntax        | Mermaid 語法錯誤   |
| shallow       | 內容過淺           |
| list_style    | 違反段落式寫作規範 |

## Output

- **文件**: `consolidation-summary.md`（完整匯總報告）
- **返回**: JSON 包含 Phase 4 所需的所有字段
